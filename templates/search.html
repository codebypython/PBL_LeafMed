{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    .main-layout {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
    }
    
    .main-content {
        flex: 1;
        min-width: 0;
    }
    
    .controls-sidebar {
        width: 350px;
        min-width: 300px;
        background: var(--bg-secondary);
        border-radius: var(--border-radius);
        padding: 1rem;
        position: sticky;
        top: 1rem;
        max-height: calc(100vh - 2rem);
        overflow-y: auto;
    }
    
    .sidebar-toggle {
        display: none;
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1000;
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
    }
    
    @media (max-width: 1200px) {
        .controls-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            height: 100vh;
            width: 400px;
            z-index: 999;
            transition: right 0.3s ease;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }
        
        .controls-sidebar.open {
            right: 0;
        }
        
        .sidebar-toggle {
            display: block;
        }
    }
    
    /* Analysis Result Panel Styles */
    .analysis-panel-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.75);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        animation: fadeIn 0.3s ease;
        overflow-y: auto;
    }
    
    .analysis-panel-overlay.show {
        display: flex;
    }
    
    .analysis-panel {
        background: var(--bg-primary);
        border-radius: var(--border-radius);
        max-width: 900px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
        position: relative;
        margin: auto;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .analysis-panel-header {
        padding: 1.5rem;
        border-bottom: 2px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .analysis-panel-header h2 {
        margin: 0;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .analysis-panel-close {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 1.5rem;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }
    
    .analysis-panel-close:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    .analysis-panel-body {
        padding: 2rem;
    }
    
    .analysis-image-section {
        text-align: center;
        margin-bottom: 2rem;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: var(--border-radius-sm);
    }
    
    .analysis-image-section img {
        max-width: 100%;
        max-height: 400px;
        border-radius: var(--border-radius-sm);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        object-fit: contain;
    }
    
    .analysis-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .analysis-info-card {
        padding: 1.25rem;
        background: var(--bg-secondary);
        border-radius: var(--border-radius-sm);
        border-left: 4px solid var(--primary);
    }
    
    .analysis-info-card h3 {
        margin: 0 0 0.75rem 0;
        font-size: 0.9rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }
    
    .analysis-info-card .value {
        font-size: 1.1rem;
        font-weight: 500;
        color: var(--text-primary);
        margin: 0;
        line-height: 1.6;
    }
    
    .analysis-info-card .value.empty {
        color: var(--text-muted);
        font-style: italic;
    }
    
    .confidence-display {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 0.5rem;
    }
    
    .confidence-value {
        font-size: 1.5rem;
        font-weight: 600;
        min-width: 60px;
    }
    
    .confidence-bar-container {
        flex: 1;
    }
    
    .confidence-bar {
        height: 10px;
        background: var(--bg-primary);
        border-radius: 5px;
        overflow: hidden;
        position: relative;
    }
    
    .confidence-bar-fill {
        height: 100%;
        transition: width 1s ease;
        border-radius: 5px;
    }
    
    .confidence-bar-fill.high {
        background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
    }
    
    .confidence-bar-fill.medium {
        background: linear-gradient(90deg, #FF9800 0%, #FFC107 100%);
    }
    
    .confidence-bar-fill.low {
        background: linear-gradient(90deg, #F44336 0%, #E91E63 100%);
    }
    
    .analysis-detail-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid var(--border-color);
    }
    
    .analysis-detail-section h3 {
        margin: 0 0 1rem 0;
        font-size: 1.2rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .analysis-detail-content {
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: var(--border-radius-sm);
        line-height: 1.8;
        color: var(--text-primary);
        white-space: pre-wrap;
    }
    
    .analysis-detail-content.empty {
        color: var(--text-muted);
        font-style: italic;
    }
    
    .analysis-panel-footer {
        padding: 1.5rem;
        border-top: 2px solid var(--border-color);
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        background: var(--bg-secondary);
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        position: sticky;
        bottom: 0;
    }
    
    .analysis-success-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(76, 175, 80, 0.1);
        color: #4CAF50;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 1rem;
    }
    
    .analysis-warning-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(255, 152, 0, 0.1);
        color: #FF9800;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 1rem;
    }
    
    .loading-skeleton {
        background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-primary) 50%, var(--bg-secondary) 75%);
        background-size: 200% 100%;
        animation: loading 1.5s ease-in-out infinite;
        border-radius: 4px;
        height: 1.2em;
        width: 60%;
        display: inline-block;
    }
    
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    .analysis-panel-footer .btn-save {
        min-width: 120px;
    }
    
    .analysis-panel-footer .btn-save:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

<div class="card">
    <div class="card-header">
        <h1 class="card-title">Tra c·ª©u th·ª±c v·∫≠t</h1>
        <p class="card-subtitle">Xem lu·ªìng video tr·ª±c ti·∫øp t·ª´ camera ho·∫∑c t·∫£i ·∫£nh t·ª´ m√°y t√≠nh ƒë·ªÉ nh·∫≠n di·ªán</p>
    </div>
    
    <!-- Status indicator -->
    <div id="piStatus" class="status-indicator" style="margin-bottom: 1rem; padding: 0.5rem; border-radius: var(--border-radius-sm); background: var(--bg-secondary);">
        <span id="statusText">ƒêang ki·ªÉm tra tr·∫°ng th√°i...</span>
    </div>
    
    <button class="sidebar-toggle" onclick="toggleSidebar()" id="sidebarToggle">‚öôÔ∏è ƒêi·ªÅu khi·ªÉn</button>
    
    <div class="main-layout">
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Tabs ƒë·ªÉ chuy·ªÉn ƒë·ªïi gi·ªØa Camera v√† Upload -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid var(--border-color);">
                <button class="tab-btn active" onclick="showTab('camera')" id="tab-camera">üìπ Camera</button>
                <button class="tab-btn" onclick="showTab('upload')" id="tab-upload">üìÅ T·∫£i ·∫£nh l√™n</button>
            </div>
            
            <!-- Tab Camera -->
            <div id="camera-tab" class="tab-content">
                <div class="stream-container">
                    <div class="stream-wrapper">
                        <img src="{{ stream_url }}" alt="Pi Stream" class="stream-image" id="streamImage">
                        <div class="stream-overlay" id="streamOverlay" style="display: none;">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem; color: white;">ƒêang x·ª≠ l√Ω...</p>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem; flex-wrap: wrap;">
                    <form method="post" action="#" id="captureForm" style="margin: 0;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary btn-lg" id="captureBtn">
                            üì∏ Ch·ª•p ·∫£nh v√† ph√¢n t√≠ch
                        </button>
                    </form>
                    <button class="btn btn-secondary" onclick="pauseStream()" id="pauseBtn">‚è∏Ô∏è T·∫°m d·ª´ng</button>
                    <button class="btn btn-secondary" onclick="resumeStream()" id="resumeBtn" style="display: none;">‚ñ∂Ô∏è Ti·∫øp t·ª•c</button>
                </div>
            </div>
            
            <!-- Tab Upload -->
            <div id="upload-tab" class="tab-content" style="display: none;">
                <div class="upload-container">
                    <form method="post" action="{% url 'upload_analyze' %}" enctype="multipart/form-data" id="uploadForm">
                        {% csrf_token %}
                        <div class="upload-area" id="uploadArea">
                            <input type="file" name="image" id="imageInput" accept="image/jpeg,image/jpg,image/png,image/webp" required style="display: none;">
                            <div class="upload-placeholder">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üì∑</div>
                                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</p>
                                <p style="color: var(--text-muted); font-size: 0.9rem;">H·ªó tr·ª£: JPG, PNG, WebP (t·ªëi ƒëa 10MB)</p>
                            </div>
                            <img id="previewImage" style="display: none; max-width: 100%; max-height: 400px; border-radius: var(--border-radius-sm); margin-top: 1rem;">
                        </div>
                        <div style="text-align: center; margin-top: 1rem;">
                            <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn" disabled>
                                üîç Ph√¢n t√≠ch ·∫£nh
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Controls Sidebar -->
        <div class="controls-sidebar" id="controlsSidebar">
            <h3 style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                <span>‚öôÔ∏è ƒêi·ªÅu khi·ªÉn Camera</span>
                <button onclick="toggleSidebar()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; display: none;" id="closeSidebar">√ó</button>
            </h3>
            
            <!-- Preset Selector (Unified Dropdown) -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 0.75rem; font-size: 1rem;">Ch·∫ø ƒë·ªô nhanh (Preset)</h4>
                
                <!-- Unified Preset Dropdown -->
                <div style="margin-bottom: 1rem;">
                    <label style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem; display: block;">Ch·ªçn preset:</label>
                    <select id="unifiedPresetSelect" class="form-control" style="margin-bottom: 0.5rem; font-size: 0.9rem;" onchange="handlePresetChange()">
                        <option value="">-- Ch·ªçn preset --</option>
                        <optgroup label="H·ªá th·ªëng" id="systemPresetsGroup">
                            <option value="system:daylight">‚òÄÔ∏è Ban ng√†y</option>
                            <option value="system:night">üåô Ban ƒë√™m</option>
                            <option value="system:sport">‚ö° Th·ªÉ thao</option>
                            <option value="system:security">üîí An ninh</option>
                        </optgroup>
                        <optgroup label="C·ªßa t√¥i" id="userPresetsGroup">
                            <!-- User presets will be loaded here -->
                        </optgroup>
                    </select>
                    <div style="display: flex; gap: 0.25rem;">
                        <button class="btn btn-sm btn-success" onclick="applySelectedPreset()" style="flex: 1; font-size: 0.85rem;">‚úÖ √Åp d·ª•ng</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSelectedPreset()" style="font-size: 0.85rem;" id="deletePresetBtn" disabled>üóëÔ∏è X√≥a</button>
                    </div>
                </div>
                
                <p id="presetStatus" style="color: var(--text-muted); font-size: 0.85rem; margin: 0;"></p>
            </div>
            
            <!-- Save Current Settings -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 0.75rem; font-size: 1rem;">L∆∞u th√¥ng s·ªë hi·ªán t·∫°i</h4>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="text" id="presetNameInput" class="form-control" placeholder="T√™n preset..." style="flex: 1; font-size: 0.9rem;">
                    <button class="btn btn-sm btn-primary" onclick="saveCurrentPreset()" style="font-size: 0.85rem;">üíæ L∆∞u</button>
                </div>
                <label style="font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="setAsDefault">
                    <span>ƒê·∫∑t l√†m m·∫∑c ƒë·ªãnh</span>
                </label>
            </div>
            
            <!-- Resolution Settings -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 0.75rem; font-size: 1rem;">üìê ƒê·ªô ph√¢n gi·∫£i</h4>
                <div style="margin-bottom: 0.5rem;">
                    <label style="font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Ch·ªçn ƒë·ªô ph√¢n gi·∫£i:</label>
                    <select id="resolutionProfile" class="form-control" style="font-size: 0.9rem; margin-bottom: 0.5rem;">
                        <option value="">ƒêang t·∫£i...</option>
                    </select>
                    <div id="resolutionInfo" style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: var(--border-radius-sm);">
                        <div><strong>Hi·ªán t·∫°i:</strong> <span id="currentResolution">-</span></div>
                        <div><strong>Megapixels:</strong> <span id="currentMegapixels">-</span> MP</div>
                        <div><strong>Max FPS:</strong> <span id="currentMaxFps">-</span> fps</div>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="changeResolution()" style="width: 100%; font-size: 0.85rem;">üîÑ √Åp d·ª•ng ƒë·ªô ph√¢n gi·∫£i</button>
                    <small style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-top: 0.25rem;">
                        ‚ö†Ô∏è Thay ƒë·ªïi ƒë·ªô ph√¢n gi·∫£i s·∫Ω kh·ªüi ƒë·ªông l·∫°i camera
                    </small>
                </div>
            </div>
            
            <!-- Manual Settings - User-Friendly UI -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem; font-size: 1rem;">ƒêi·ªÅu ch·ªânh h√¨nh ·∫£nh</h4>
                
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Zoom -->
                    <div>
                        <label style="font-size: 0.9rem; display: block; margin-bottom: 0.25rem;">üîç ƒê·ªô ph√≥ng ƒë·∫°i: <span id="zoomValue">100%</span></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('zoom', -5)" style="font-size: 0.85rem; min-width: 2rem;">-</button>
                            <input type="range" id="zoom" class="form-control" min="100" max="400" step="5" value="100" 
                                   oninput="updateUISettingDisplay('zoom', this.value); debouncedApplyUISetting('zoom', 'zoom');">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('zoom', 5)" style="font-size: 0.85rem; min-width: 2rem;">+</button>
                        </div>
                        <small style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-top: 0.25rem;">
                            100% = kh√¥ng zoom, 200% = zoom 2x, 400% = zoom 4x
                        </small>
                    </div>
                    
                    <!-- Brightness -->
                    <div>
                        <label style="font-size: 0.9rem; display: block; margin-bottom: 0.25rem;">ƒê·ªô s√°ng: <span id="brightnessValue">0%</span></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('brightness', -5)" style="font-size: 0.85rem; min-width: 2rem;">-</button>
                        <input type="range" id="brightness" class="form-control" min="-100" max="100" step="1" value="0" 
                                   oninput="updateUISettingDisplay('brightness', this.value); debouncedApplyUISetting('brightness', 'brightness');">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('brightness', 5)" style="font-size: 0.85rem; min-width: 2rem;">+</button>
                        </div>
                    </div>
                    
                    <!-- Sharpness -->
                    <div>
                        <label style="font-size: 0.9rem; display: block; margin-bottom: 0.25rem;">ƒê·ªô n√©t: <span id="sharpnessValue">100%</span></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('sharpness', -5)" style="font-size: 0.85rem; min-width: 2rem;">-</button>
                            <input type="range" id="sharpness" class="form-control" min="0" max="200" step="5" value="100" 
                                   oninput="updateUISettingDisplay('sharpness', this.value); debouncedApplyUISetting('sharpness', 'sharpness');">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('sharpness', 5)" style="font-size: 0.85rem; min-width: 2rem;">+</button>
                        </div>
                    </div>
                    
                    <!-- Contrast -->
                    <div>
                        <label style="font-size: 0.9rem; display: block; margin-bottom: 0.25rem;">ƒê·ªô t∆∞∆°ng ph·∫£n: <span id="contrastValue">100%</span></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('contrast', -5)" style="font-size: 0.85rem; min-width: 2rem;">-</button>
                            <input type="range" id="contrast" class="form-control" min="0" max="200" step="5" value="100" 
                                   oninput="updateUISettingDisplay('contrast', this.value); debouncedApplyUISetting('contrast', 'contrast');">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('contrast', 5)" style="font-size: 0.85rem; min-width: 2rem;">+</button>
                        </div>
                    </div>
                    
                    <!-- Saturation -->
                    <div>
                        <label style="font-size: 0.9rem; display: block; margin-bottom: 0.25rem;">ƒê·ªô b√£o h√≤a m√†u: <span id="saturationValue">100%</span></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('saturation', -5)" style="font-size: 0.85rem; min-width: 2rem;">-</button>
                            <input type="range" id="saturation" class="form-control" min="0" max="200" step="5" value="100" 
                                   oninput="updateUISettingDisplay('saturation', this.value); debouncedApplyUISetting('saturation', 'saturation');">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('saturation', 5)" style="font-size: 0.85rem; min-width: 2rem;">+</button>
                        </div>
                    </div>
                    
                    <!-- Background Blur -->
                    <div>
                        <label style="font-size: 0.9rem; display: block; margin-bottom: 0.25rem;">L√†m m·ªù v·∫≠t th·ªÉ ph·ª•: <span id="backgroundBlurValue">0%</span></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('backgroundBlur', -5)" style="font-size: 0.85rem; min-width: 2rem;">-</button>
                            <input type="range" id="backgroundBlur" class="form-control" min="0" max="100" step="5" value="0" 
                                   oninput="updateUISettingDisplay('backgroundBlur', this.value); debouncedApplyUISetting('background_blur', 'backgroundBlur');">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('backgroundBlur', 5)" style="font-size: 0.85rem; min-width: 2rem;">+</button>
                        </div>
                        <small style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-top: 0.25rem;">Gi·∫£m ƒë·ªô n√©t v√πng n·ªÅn ƒë·ªÉ l√†m n·ªïi b·∫≠t ch·ªß th·ªÉ</small>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button class="btn btn-sm btn-secondary" onclick="loadUISettings()" style="flex: 1; font-size: 0.85rem;">üì• T·∫£i th√¥ng s·ªë</button>
                    <button class="btn btn-sm btn-secondary" onclick="resetToDefault()" style="flex: 1; font-size: 0.85rem;">üîÑ M·∫∑c ƒë·ªãnh</button>
                </div>
            </div>
            
            <!-- System Control -->
            <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 0.75rem; font-size: 1rem;">ƒêi·ªÅu khi·ªÉn h·ªá th·ªëng</h4>
                <div style="display: flex; gap: 0.5rem; flex-direction: column;">
                    <button class="btn btn-sm btn-warning" onclick="restartCamera()" style="font-size: 0.85rem;">üîÑ Kh·ªüi ƒë·ªông l·∫°i Camera</button>
                    <button class="btn btn-sm btn-warning" onclick="reloadModel()" style="font-size: 0.85rem;">üîÑ T·∫£i l·∫°i Model</button>
                </div>
            </div>
            
            <!-- Current Settings Info (Expanded) -->
            <div style="padding: 1rem; background: var(--bg-primary); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); max-height: 70vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <h4 style="margin: 0; font-size: 1rem;">Tr·∫°ng th√°i Camera</h4>
                    <button class="btn btn-sm btn-secondary" onclick="refreshCameraStatus()" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">üîÑ</button>
                </div>
                
                <!-- System Status -->
                <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--primary);">H·ªá th·ªëng</h5>
                <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>Tr·∫°ng th√°i:</strong> <span id="settingsState">-</span></p>
                <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>Preset:</strong> <span id="settingsPreset">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>Ch·∫ø ƒë·ªô:</strong> <span id="settingsMode">-</span></p>
            </div>
                
                <!-- Resolution Info -->
                <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--primary);">ƒê·ªô ph√¢n gi·∫£i</h5>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>K√≠ch th∆∞·ªõc:</strong> <span id="statusResolution">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>Megapixels:</strong> <span id="statusMegapixels">-</span> MP</p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>Frame Rate:</strong> <span id="statusFps">-</span> fps</p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>T·ª∑ l·ªá khung h√¨nh:</strong> <span id="statusAspectRatio">-</span></p>
        </div>
                
                <!-- Exposure Settings -->
                <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--primary);">Ph∆°i s√°ng</h5>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>ISO (AnalogueGain):</strong> <span id="statusAnalogueGain">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>Th·ªùi gian ph∆°i s√°ng:</strong> <span id="statusExposureTime">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>B√π ph∆°i s√°ng (EV):</strong> <span id="statusExposureValue">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>T·ª± ƒë·ªông ph∆°i s√°ng:</strong> <span id="statusAeEnable">-</span></p>
                </div>
                
                <!-- Image Quality Settings -->
                <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--primary);">Ch·∫•t l∆∞·ª£ng h√¨nh ·∫£nh</h5>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>ƒê·ªô t∆∞∆°ng ph·∫£n:</strong> <span id="statusContrast">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>ƒê·ªô b√£o h√≤a:</strong> <span id="statusSaturation">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>ƒê·ªô n√©t:</strong> <span id="statusSharpness">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>C√¢n b·∫±ng tr·∫Øng t·ª± ƒë·ªông:</strong> <span id="statusAwbEnable">-</span></p>
                </div>
            </div>
        </div>
    </div>
</div>
  
  <script src="{% static 'js/search.js' %}"></script>
  <script src="{% static 'js/camera-controls.js' %}"></script>
  <script>
    // Kh·ªüi t·∫°o
    const PI_BASE_URL = '{{ pi_base }}';
    const STREAM_URL = '{{ stream_url }}';
    
    // Ki·ªÉm tra tr·∫°ng th√°i khi load
    checkPiStatus();
    setInterval(checkPiStatus, 30000);
    loadUnifiedPresets(); // Load unified presets khi trang load
    refreshCameraStatus(); // Load camera status khi trang load
    
    // Auto-refresh camera status every 5 seconds
    setInterval(refreshCameraStatus, 5000);
    
    // Load resolution profiles khi trang load
    if (window.loadResolutionProfiles) {
        setTimeout(() => {
            loadResolutionProfiles();
        }, 500); // ƒê·ª£i camera-controls.js kh·ªüi t·∫°o xong
    }
    
    // Sidebar toggle cho mobile
    function toggleSidebar() {
        const sidebar = document.getElementById('controlsSidebar');
        sidebar.classList.toggle('open');
    }
    
    // Tab switching
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.style.display = 'none';
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        document.getElementById(tabName + '-tab').style.display = 'block';
        document.getElementById('tab-' + tabName).classList.add('active');
    }
    
    // Upload functionality
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const previewImage = document.getElementById('previewImage');
    const uploadBtn = document.getElementById('uploadBtn');
    
    uploadArea.addEventListener('click', () => imageInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--primary)';
        uploadArea.style.background = 'rgba(212, 175, 55, 0.05)';
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = 'var(--border-color)';
        uploadArea.style.background = 'var(--bg-primary)';
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--border-color)';
        uploadArea.style.background = 'var(--bg-primary)';
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
            imageInput.files = files;
            handleFileSelect(files[0]);
        }
    });
    
    imageInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    function handleFileSelect(file) {
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert('Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh: JPG, PNG, WebP');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            alert('File ·∫£nh qu√° l·ªõn (t·ªëi ƒëa 10MB)');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block';
            document.querySelector('.upload-placeholder').style.display = 'none';
            uploadBtn.disabled = false;
        };
        reader.readAsDataURL(file);
    }
    
    // Capture form - Two-step process: Preview first, then analyze
    document.getElementById('captureForm').addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default form submission
        
        const captureBtn = document.getElementById('captureBtn');
        const streamOverlay = document.getElementById('streamOverlay');
        const streamImage = document.getElementById('streamImage');
        const originalStreamUrl = streamImage.src;
        
        // Step 1: Disable button and show loading
        captureBtn.disabled = true;
        captureBtn.textContent = 'üì∏ ƒêang ch·ª•p...';
        streamOverlay.style.display = 'flex';
        
        // Step 2: Capture preview (ch·ªâ capture, KH√îNG ph√¢n t√≠ch)
        fetch('/api/capture/preview/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'L·ªói ch·ª•p ·∫£nh');
            }
            
            // Step 3: Hi·ªÉn th·ªã ·∫£nh ƒë√£ ch·ª•p ngay l·∫≠p t·ª©c (t·∫°o hi·ªáu ·ª©ng "d·ª´ng h√¨nh")
            let capturedImageUrl = '';
            if (data.image_b64_thumbnail) {
                capturedImageUrl = 'data:image/jpeg;base64,' + data.image_b64_thumbnail;
                streamImage.src = capturedImageUrl;
            } else if (data.image_b64) {
                capturedImageUrl = 'data:image/jpeg;base64,' + data.image_b64;
                streamImage.src = capturedImageUrl;
            } else if (data.image_url) {
                if (data.image_url.startsWith('/')) {
                    capturedImageUrl = PI_BASE_URL + data.image_url;
                } else {
                    capturedImageUrl = data.image_url;
                }
                streamImage.src = capturedImageUrl;
            } else if (data.file) {
                capturedImageUrl = PI_BASE_URL + '/history/image/' + data.file;
                streamImage.src = capturedImageUrl;
            }
            
            // Step 4: Hi·ªÉn th·ªã panel ngay v·ªõi loading state
            captureBtn.textContent = 'üîç ƒêang ph√¢n t√≠ch...';
            showAnalysisPanelLoading({
                file: data.file,
                image_url: capturedImageUrl || (data.image_url ? (data.image_url.startsWith('/') ? PI_BASE_URL + data.image_url : data.image_url) : ''),
                image_size_bytes: data.image_size_bytes
            });
            
            // Step 5: Ph√¢n t√≠ch ·∫£nh ƒë√£ capture ·ªü background
            fetch('/api/capture/analyze/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: data.file
                }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(analysisResult => {
                if (!analysisResult.success) {
                    throw new Error(analysisResult.error || 'L·ªói ph√¢n t√≠ch');
                }
                
                // Step 6: C·∫≠p nh·∫≠t panel v·ªõi k·∫øt qu·∫£ ph√¢n t√≠ch
                captureBtn.textContent = '‚úÖ Ho√†n th√†nh!';
                updateAnalysisPanelWithResult(analysisResult);
                
                // Restore stream
                streamImage.src = originalStreamUrl;
                captureBtn.disabled = false;
                captureBtn.textContent = 'üì∏ Ch·ª•p ·∫£nh v√† ph√¢n t√≠ch';
                streamOverlay.style.display = 'none';
            })
            .catch(error => {
                console.error('Analysis error:', error);
                // Hi·ªÉn th·ªã l·ªói trong panel
                updateAnalysisPanelWithError(error.message);
                // Restore stream
                streamImage.src = originalStreamUrl;
                captureBtn.disabled = false;
                captureBtn.textContent = 'üì∏ Ch·ª•p ·∫£nh v√† ph√¢n t√≠ch';
                streamOverlay.style.display = 'none';
            });
        })
        .catch(error => {
            console.error('Capture error:', error);
            alert('L·ªói: ' + error.message);
            
            // Restore stream
            streamImage.src = originalStreamUrl;
            captureBtn.disabled = false;
            captureBtn.textContent = 'üì∏ Ch·ª•p ·∫£nh v√† ph√¢n t√≠ch';
            streamOverlay.style.display = 'none';
        });
    });
    
    // Analysis Panel Functions
    let currentAnalysisData = null; // L∆∞u d·ªØ li·ªáu ph√¢n t√≠ch hi·ªán t·∫°i
    
    function showAnalysisPanelLoading(previewData) {
        const panel = document.getElementById('analysisPanel');
        const panelBody = document.getElementById('analysisPanelBody');
        const panelFooter = document.querySelector('.analysis-panel-footer');
        
        // L∆∞u preview data
        currentAnalysisData = {
            ...previewData,
            loading: true
        };
        
        // T·∫°o HTML cho panel v·ªõi loading state
        panelBody.innerHTML = `
            <div class="analysis-image-section">
                <img src="${escapeHtml(previewData.image_url)}" alt="Captured image" id="analysisPanelImage">
            </div>
            
            <div class="analysis-info-grid">
                <div class="analysis-info-card">
                    <h3>üåø T√™n ti·∫øng Vi·ªát</h3>
                    <p class="value"><span class="loading-skeleton"></span></p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üî¨ T√™n khoa h·ªçc</h3>
                    <p class="value"><span class="loading-skeleton"></span></p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üåç T√™n ti·∫øng Anh</h3>
                    <p class="value"><span class="loading-skeleton"></span></p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üìä ƒê·ªô tin c·∫≠y</h3>
                    <div class="confidence-display">
                        <span class="confidence-value"><span class="loading-skeleton" style="width: 60px;"></span></span>
                        <div class="confidence-bar-container">
                            <div class="confidence-bar">
                                <div class="confidence-bar-fill" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üìè K√≠ch th∆∞·ªõc ·∫£nh</h3>
                    <p class="value">${previewData.image_size_bytes ? (previewData.image_size_bytes / 1024).toFixed(1) + ' KB' : 'N/A'}</p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üìÖ Th·ªùi gian</h3>
                    <p class="value">${new Date().toLocaleString('vi-VN')}</p>
                </div>
            </div>
            
            <div class="analysis-detail-section">
                <h3>üìù M√¥ t·∫£ chi ti·∫øt</h3>
                <div class="analysis-detail-content"><span class="loading-skeleton"></span></div>
            </div>
            
            <div class="analysis-detail-section">
                <h3>üíä C√¥ng d·ª•ng</h3>
                <div class="analysis-detail-content"><span class="loading-skeleton"></span></div>
            </div>
            
            <div class="analysis-detail-section">
                <h3>üìç V·ªã tr√≠ ph√¢n b·ªë</h3>
                <div class="analysis-detail-content"><span class="loading-skeleton"></span></div>
            </div>
        `;
        
        // C·∫≠p nh·∫≠t footer v·ªõi n√∫t disabled
        if (panelFooter) {
            panelFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeAnalysisPanel()">ƒê√≥ng</button>
                <button class="btn btn-primary btn-save" id="saveResultBtn" disabled>
                    üíæ L∆∞u k·∫øt qu·∫£
                </button>
            `;
        }
        
        // Hi·ªÉn th·ªã panel v·ªõi animation
        panel.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
    
    function updateAnalysisPanelWithResult(analysisResult) {
        const panelBody = document.getElementById('analysisPanelBody');
        const panelFooter = document.querySelector('.analysis-panel-footer');
        
        // Ki·ªÉm tra c√°c tr∆∞·ªùng h·ª£p kh√¥ng ƒë∆∞·ª£c l∆∞u
        const label = (analysisResult.name || '').toLowerCase();
        const isNotSavable = label === 'background' || label === 'green_but_not_leaf';
        
        // X√°c ƒë·ªãnh ƒë·ªô tin c·∫≠y v√† m√†u s·∫Øc
        const confidencePercent = Math.round((analysisResult.confidence || 0) * 100);
        let confidenceClass = 'high';
        let confidenceColor = '#4CAF50';
        if (confidencePercent < 70) {
            confidenceClass = 'medium';
            confidenceColor = '#FF9800';
        }
        if (confidencePercent < 50) {
            confidenceClass = 'low';
            confidenceColor = '#F44336';
        }
        
        // Gi·ªØ l·∫°i image_url t·ª´ preview n·∫øu ƒë√£ c√≥ (∆∞u ti√™n base64 ho·∫∑c full URL t·ª´ preview)
        // Ch·ªâ d√πng image_url t·ª´ analysisResult n·∫øu preview kh√¥ng c√≥
        let preservedImageUrl = '';
        if (currentAnalysisData?.image_url) {
            // ∆Øu ti√™n image_url t·ª´ preview (c√≥ th·ªÉ l√† base64 ho·∫∑c full URL)
            preservedImageUrl = currentAnalysisData.image_url;
            console.log('[Panel] Using image_url from preview:', preservedImageUrl.substring(0, 50) + '...');
        } else if (analysisResult.image_url) {
            // Fallback: d√πng image_url t·ª´ analysisResult
            preservedImageUrl = analysisResult.image_url.startsWith('/') ? 
                                PI_BASE_URL + analysisResult.image_url : 
                                analysisResult.image_url;
            console.log('[Panel] Using image_url from analysisResult:', preservedImageUrl);
        } else if (analysisResult.file) {
            // Fallback cu·ªëi c√πng: t·∫°o URL t·ª´ filename
            preservedImageUrl = PI_BASE_URL + '/history/image/' + analysisResult.file;
            console.log('[Panel] Using image_url from filename:', preservedImageUrl);
        }
        
        if (!preservedImageUrl) {
            console.warn('[Panel] No image_url found!', { currentAnalysisData, analysisResult });
        }
        
        // C·∫≠p nh·∫≠t currentAnalysisData - gi·ªØ l·∫°i image_url t·ª´ preview
        // Lo·∫°i b·ªè image_url t·ª´ analysisResult tr∆∞·ªõc khi merge ƒë·ªÉ tr√°nh ghi ƒë√®
        const { image_url: _, ...analysisResultWithoutImageUrl } = analysisResult;
        currentAnalysisData = {
            ...currentAnalysisData,
            ...analysisResultWithoutImageUrl,
            image_url: preservedImageUrl, // Lu√¥n d√πng preservedImageUrl (t·ª´ preview ho·∫∑c fallback)
            loading: false,
            isNotSavable: isNotSavable
        };
        
        // T·∫°o HTML v·ªõi k·∫øt qu·∫£ ph√¢n t√≠ch
        panelBody.innerHTML = `
            ${isNotSavable ? `
            <div class="analysis-warning-badge">
                ‚ö†Ô∏è K·∫øt qu·∫£ n√†y kh√¥ng ƒë∆∞·ª£c l∆∞u v√†o database: "${escapeHtml(analysisResult.name)}"
            </div>
            ` : ''}
            
            <div class="analysis-image-section">
                <img src="${escapeHtml(preservedImageUrl)}" alt="Captured image" id="analysisPanelImage" 
                     onerror="console.error('Failed to load image:', this.src); this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'400\\' height=\\'300\\'%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dominant-baseline=\\'middle\\' fill=\\'%23999\\'%3EKh√¥ng th·ªÉ t·∫£i ·∫£nh%3C/text%3E%3C/svg%3E';">
            </div>
            
            <div class="analysis-info-grid">
                <div class="analysis-info-card">
                    <h3>üåø T√™n ti·∫øng Vi·ªát</h3>
                    <p class="value">${escapeHtml(analysisResult.name || 'ƒêang ph√¢n t√≠ch...')}</p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üî¨ T√™n khoa h·ªçc</h3>
                    <p class="value empty">Ch∆∞a c√≥ th√¥ng tin</p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üåç T√™n ti·∫øng Anh</h3>
                    <p class="value empty">Ch∆∞a c√≥ th√¥ng tin</p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üìä ƒê·ªô tin c·∫≠y</h3>
                    <div class="confidence-display">
                        <span class="confidence-value" style="color: ${confidenceColor};">${confidencePercent}%</span>
                        <div class="confidence-bar-container">
                            <div class="confidence-bar">
                                <div class="confidence-bar-fill ${confidenceClass}" style="width: ${confidencePercent}%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üìè K√≠ch th∆∞·ªõc ·∫£nh</h3>
                    <p class="value">${currentAnalysisData.image_size_bytes ? (currentAnalysisData.image_size_bytes / 1024).toFixed(1) + ' KB' : 'N/A'}</p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üìÖ Th·ªùi gian</h3>
                    <p class="value">${new Date().toLocaleString('vi-VN')}</p>
                </div>
            </div>
            
            <div class="analysis-detail-section">
                <h3>üìù M√¥ t·∫£ chi ti·∫øt</h3>
                <div class="analysis-detail-content empty">Ch∆∞a c√≥ th√¥ng tin</div>
            </div>
            
            <div class="analysis-detail-section">
                <h3>üíä C√¥ng d·ª•ng</h3>
                <div class="analysis-detail-content empty">Ch∆∞a c√≥ th√¥ng tin</div>
            </div>
            
            <div class="analysis-detail-section">
                <h3>üìç V·ªã tr√≠ ph√¢n b·ªë</h3>
                <div class="analysis-detail-content empty">Ch∆∞a c√≥ th√¥ng tin</div>
            </div>
        `;
        
        // C·∫≠p nh·∫≠t footer v·ªõi n√∫t l∆∞u (disabled n·∫øu kh√¥ng ƒë∆∞·ª£c l∆∞u)
        if (panelFooter) {
            panelFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeAnalysisPanel()">ƒê√≥ng</button>
                <button class="btn btn-primary btn-save" id="saveResultBtn" onclick="saveAnalysisResult()" ${isNotSavable ? 'disabled' : ''}>
                    üíæ L∆∞u k·∫øt qu·∫£
                </button>
            `;
        }
    }
    
    function updateAnalysisPanelWithError(errorMessage) {
        const panelBody = document.getElementById('analysisPanelBody');
        const panelFooter = document.querySelector('.analysis-panel-footer');
        
        panelBody.innerHTML = `
            <div class="analysis-warning-badge">
                ‚ùå L·ªói ph√¢n t√≠ch: ${escapeHtml(errorMessage)}
            </div>
            
            <div class="analysis-image-section">
                <img src="${escapeHtml(currentAnalysisData?.image_url || '')}" alt="Captured image" id="analysisPanelImage">
            </div>
        `;
        
        if (panelFooter) {
            panelFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeAnalysisPanel()">ƒê√≥ng</button>
            `;
        }
    }
    
    function saveAnalysisResult() {
        if (!currentAnalysisData || currentAnalysisData.loading || currentAnalysisData.isNotSavable) {
            return;
        }
        
        const saveBtn = document.getElementById('saveResultBtn');
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.textContent = '‚è≥ ƒêang l∆∞u...';
        
        fetch('/api/capture/save/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: currentAnalysisData.name,
                confidence: currentAnalysisData.confidence,
                file: currentAnalysisData.file,
                image_url: currentAnalysisData.image_url,
                image_size_bytes: currentAnalysisData.image_size_bytes
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                const panelBody = document.getElementById('analysisPanelBody');
                const successBadge = document.createElement('div');
                successBadge.className = 'analysis-success-badge';
                successBadge.style.marginBottom = '1rem';
                successBadge.innerHTML = '‚úÖ ' + data.message;
                
                // Th√™m badge v√†o ƒë·∫ßu panel body
                panelBody.insertBefore(successBadge, panelBody.firstChild);
                
                // ƒê·ªïi n√∫t l∆∞u th√†nh "ƒê√£ l∆∞u"
                saveBtn.textContent = '‚úÖ ƒê√£ l∆∞u';
                saveBtn.disabled = true;
                saveBtn.classList.remove('btn-primary');
                saveBtn.classList.add('btn-secondary');
                
                // C·∫≠p nh·∫≠t currentAnalysisData ƒë·ªÉ ƒë√°nh d·∫•u ƒë√£ l∆∞u
                currentAnalysisData.saved = true;
                
                // C·∫≠p nh·∫≠t panel v·ªõi th√¥ng tin ƒë·∫ßy ƒë·ªß t·ª´ database n·∫øu c√≥
                if (data.result) {
                    updatePanelWithFullData(data.result);
                }
            } else {
                throw new Error(data.error || 'L·ªói l∆∞u k·∫øt qu·∫£');
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            alert('L·ªói: ' + error.message);
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        });
    }
    
    function updatePanelWithFullData(fullData) {
        const panelBody = document.getElementById('analysisPanelBody');
        
        // C·∫≠p nh·∫≠t c√°c tr∆∞·ªùng v·ªõi d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß t·ª´ database
        const nameCard = panelBody.querySelector('.analysis-info-card:nth-child(2) .value');
        if (nameCard) {
            nameCard.textContent = fullData.vietnamese_name || fullData.name || '';
            nameCard.classList.remove('empty');
        }
        
        const scientificCard = panelBody.querySelector('.analysis-info-card:nth-child(3) .value');
        if (scientificCard && fullData.scientific_name) {
            scientificCard.textContent = fullData.scientific_name;
            scientificCard.classList.remove('empty');
        }
        
        const englishCard = panelBody.querySelector('.analysis-info-card:nth-child(4) .value');
        if (englishCard && fullData.english_name) {
            englishCard.textContent = fullData.english_name;
            englishCard.classList.remove('empty');
        }
        
        // C·∫≠p nh·∫≠t c√°c section chi ti·∫øt
        if (fullData.description) {
            const descSection = panelBody.querySelector('.analysis-detail-section:nth-child(4) .analysis-detail-content');
            if (descSection) {
                descSection.textContent = fullData.description;
                descSection.classList.remove('empty');
            }
        }
        
        if (fullData.usage) {
            const usageSection = panelBody.querySelector('.analysis-detail-section:nth-child(5) .analysis-detail-content');
            if (usageSection) {
                usageSection.textContent = fullData.usage;
                usageSection.classList.remove('empty');
            }
        }
        
        if (fullData.common_locations) {
            const locationSection = panelBody.querySelector('.analysis-detail-section:nth-child(6) .analysis-detail-content');
            if (locationSection) {
                locationSection.textContent = fullData.common_locations;
                locationSection.classList.remove('empty');
            }
        }
        
        // Th√™m c√°c section kh√°c n·∫øu c√≥
        if (fullData.biological_info) {
            let bioSection = panelBody.querySelector('.analysis-detail-section:nth-child(7)');
            if (!bioSection) {
                bioSection = document.createElement('div');
                bioSection.className = 'analysis-detail-section';
                bioSection.innerHTML = `
                    <h3>üî¨ Th√¥ng tin sinh h·ªçc</h3>
                    <div class="analysis-detail-content">${escapeHtml(fullData.biological_info)}</div>
                `;
                panelBody.appendChild(bioSection);
            }
        }
        
        if (fullData.medicinal_info) {
            let medSection = panelBody.querySelector('.analysis-detail-section:nth-child(8)');
            if (!medSection) {
                medSection = document.createElement('div');
                medSection.className = 'analysis-detail-section';
                medSection.innerHTML = `
                    <h3>üíâ Th√¥ng tin d∆∞·ª£c li·ªáu</h3>
                    <div class="analysis-detail-content">${escapeHtml(fullData.medicinal_info)}</div>
                `;
                panelBody.appendChild(medSection);
            }
        }
    }
    
    function closeAnalysisPanel() {
        const panel = document.getElementById('analysisPanel');
        panel.classList.remove('show');
        document.body.style.overflow = ''; // Restore scrolling
        currentAnalysisData = null; // Reset data
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // ============================================================
    // CAMERA CONTROLS HELPERS - Simplified Logic
    // ============================================================
    
    // Debounce timers cho auto-apply
    const debounceTimers = {};
    
    // Map elementId to setting name
    const settingNameMap = {
        'zoom': 'zoom',
        'brightness': 'brightness',
        'sharpness': 'sharpness',
        'contrast': 'contrast',
        'saturation': 'saturation',
        'backgroundBlur': 'background_blur'
    };
    
    /**
     * Update UI display value (ch·ªâ update hi·ªÉn th·ªã, kh√¥ng apply)
     * QUAN TR·ªåNG: H√†m n√†y ch·ªâ update display text, KH√îNG update slider value
     * Slider value ƒë∆∞·ª£c update b·ªüi camera-controls.js th√¥ng qua updateControl()
     */
    function updateUISettingDisplay(elementId, value) {
        const val = parseFloat(value) || 0;
        const valueElement = document.getElementById(elementId + 'Value');
        if (!valueElement) return;
        
        // Format display based on element type
        if (elementId === 'brightness') {
            valueElement.textContent = (val >= 0 ? '+' : '') + val.toFixed(0) + '%';
        } else {
            valueElement.textContent = val.toFixed(0) + '%';
        }
        
        // Update slider background (ch·ªâ visual, kh√¥ng trigger event)
        const slider = document.getElementById(elementId);
        if (slider && window.cameraControls && window.cameraControls.ui) {
            window.cameraControls.ui.updateRangeBackground(slider);
        }
    }
    
    /**
     * Apply UI setting v·ªõi validation
     */
    async function applyUISettingSafe(settingName, elementId) {
        const element = document.getElementById(elementId);
        if (!element) {
            console.error(`[UI] Element not found: ${elementId}`);
            return;
        }
        
        let value = parseFloat(element.value);
        
        // Validate
        if (isNaN(value)) {
            console.error(`[UI] Invalid value for ${settingName}:`, element.value);
            return;
        }
        
        // Clamp gi√° tr·ªã
        const min = parseFloat(element.min) || 0;
        const max = parseFloat(element.max) || 100;
        value = Math.max(min, Math.min(max, value));
        
        // Update element n·∫øu b·ªã clamp
        if (element.value != value) {
            element.value = value;
            updateUISettingDisplay(elementId, value);
        }
        
        // Apply setting
        if (window.cameraControls && window.cameraControls.applyUISetting) {
            try {
                await window.cameraControls.applyUISetting(settingName, value);
            } catch (error) {
                console.error(`[UI] Error applying ${settingName}:`, error);
                alert(`L·ªói khi √°p d·ª•ng ${settingName}: ${error.message}`);
            }
        } else {
            console.error('[UI] cameraControls not available');
        }
    }
    
    /**
     * Debounced apply - T·ª± ƒë·ªông apply sau khi user ng·ª´ng ƒëi·ªÅu ch·ªânh
     * QUAN TR·ªåNG: Ch·ªâ apply khi user th·ª±c s·ª± ƒëi·ªÅu ch·ªânh, KH√îNG apply khi update programmatically
     */
    function debouncedApplyUISetting(settingName, elementId) {
        const element = document.getElementById(elementId);
        
        // QUAN TR·ªåNG: Skip n·∫øu ƒëang update programmatically (t·ª´ server)
        // ƒêi·ªÅu n√†y tr√°nh loop: update t·ª´ server ‚Üí trigger oninput ‚Üí apply l·∫°i ‚Üí update t·ª´ server
        if (element && element.dataset.programmaticUpdate === 'true') {
            console.log(`[UI] Skipping debounced apply for ${settingName} - programmatic update in progress`);
            return;
        }
        
        // Clear existing timer
        if (debounceTimers[settingName]) {
            clearTimeout(debounceTimers[settingName]);
        }
        
        // Set new timer (300ms delay)
        debounceTimers[settingName] = setTimeout(() => {
            // Double check: v·∫´n skip n·∫øu ƒëang update programmatically
            if (element && element.dataset.programmaticUpdate === 'true') {
                console.log(`[UI] Skipping apply for ${settingName} - still programmatic update`);
                return;
            }
            applyUISettingSafe(settingName, elementId);
        }, 300);
    }
    
    /**
     * Adjust UI setting by step (d√πng cho n√∫t +/-)
     */
    function adjustUISetting(elementId, step) {
        const element = document.getElementById(elementId);
        if (!element) {
            console.error(`[UI] Element not found: ${elementId}`);
            return;
        }
        
        const currentValue = parseFloat(element.value) || 0;
        const min = parseFloat(element.min) || 0;
        const max = parseFloat(element.max) || 100;
        const stepValue = parseFloat(element.step) || 5;
        
        // Calculate new value
        let newValue = currentValue + (step * stepValue);
        newValue = Math.max(min, Math.min(max, newValue));
        
        // Update slider v√† display
        element.value = newValue;
        updateUISettingDisplay(elementId, newValue);
        
        // Apply immediately (no debounce for button clicks)
        const settingName = settingNameMap[elementId];
        if (settingName) {
            applyUISettingSafe(settingName, elementId);
        }
    }
    
    // ƒê√≥ng panel khi click v√†o overlay
    document.addEventListener('DOMContentLoaded', function() {
        const panel = document.getElementById('analysisPanel');
        if (panel) {
            panel.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAnalysisPanel();
                }
            });
        }
        
        // ƒê√≥ng panel khi nh·∫•n ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && panel && panel.classList.contains('show')) {
                closeAnalysisPanel();
            }
        });
    });
    
    // Handle stream image errors
    document.getElementById('streamImage').addEventListener('error', function() {
        this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dominant-baseline="middle" fill="%23999"%3EStream kh√¥ng kh·∫£ d·ª•ng%3C/text%3E%3C/svg%3E';
    });
    
    // NOTE: Camera controls initialization is handled by camera-controls.js
    // Range sliders, resolution profiles, and settings are auto-initialized
</script>

<!-- Analysis Result Panel -->
<div class="analysis-panel-overlay" id="analysisPanel">
    <div class="analysis-panel">
        <div class="analysis-panel-header">
            <h2>
                <span>üîç</span>
                <span>K·∫øt qu·∫£ ph√¢n t√≠ch</span>
            </h2>
            <button class="analysis-panel-close" onclick="closeAnalysisPanel()" aria-label="ƒê√≥ng">√ó</button>
        </div>
        <div class="analysis-panel-body" id="analysisPanelBody">
            <!-- Content will be populated by JavaScript -->
        </div>
        <div class="analysis-panel-footer">
            <button class="btn btn-secondary" onclick="closeAnalysisPanel()">ƒê√≥ng</button>
        </div>
    </div>
</div>

{% endblock %}
