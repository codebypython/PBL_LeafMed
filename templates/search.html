{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/search.css' %}">

<div class="card">
    <div class="card-header">
        <h1 class="card-title">Tra c·ª©u th·ª±c v·∫≠t</h1>
        <p class="card-subtitle">Xem lu·ªìng video tr·ª±c ti·∫øp t·ª´ camera ho·∫∑c t·∫£i ·∫£nh t·ª´ m√°y t√≠nh ƒë·ªÉ nh·∫≠n di·ªán</p>
    </div>
    
    <!-- Status indicator -->
    <div id="piStatus" class="status-indicator" style="margin-bottom: 1rem; padding: 0.5rem; border-radius: var(--border-radius-sm); background: var(--bg-secondary);">
        <span id="statusText">ƒêang ki·ªÉm tra tr·∫°ng th√°i...</span>
    </div>
    
    <button class="sidebar-toggle" onclick="toggleSidebar()" id="sidebarToggle">‚öôÔ∏è ƒêi·ªÅu khi·ªÉn</button>
    
    <div class="main-layout">
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Tabs ƒë·ªÉ chuy·ªÉn ƒë·ªïi gi·ªØa Camera v√† Upload -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid var(--border-color);">
                <button class="tab-btn active" onclick="showTab('camera')" id="tab-camera">üìπ Camera</button>
                <button class="tab-btn" onclick="showTab('upload')" id="tab-upload">üìÅ T·∫£i ·∫£nh l√™n</button>
            </div>
            
            <!-- Tab Camera -->
            <div id="camera-tab" class="tab-content">
                <div class="stream-container" style="position: relative;">
                    <div class="stream-wrapper">
                        <img src="{{ stream_url }}" alt="Pi Stream" class="stream-image" id="streamImage">
                        <canvas id="yoloOverlayCanvas" style="position: absolute; top: 0; left: 0; z-index: 10;"></canvas>
                        <div class="stream-overlay" id="streamOverlay">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem; color: white;">ƒêang x·ª≠ l√Ω...</p>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem; flex-wrap: wrap;">
                    <form method="post" action="#" id="captureForm" style="margin: 0;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary btn-lg" id="captureBtn">
                            üì∏ Ch·ª•p ·∫£nh v√† ph√¢n t√≠ch
                        </button>
                    </form>
                    <button class="btn btn-secondary" onclick="pauseStream()" id="pauseBtn">‚è∏Ô∏è T·∫°m d·ª´ng</button>
                    <button class="btn btn-secondary" onclick="resumeStream()" id="resumeBtn" style="display: none;">‚ñ∂Ô∏è Ti·∫øp t·ª•c</button>
                </div>        
            </div>
            
            <!-- Tab Upload -->
            <div id="upload-tab" class="tab-content" style="display: none;">
                <div class="upload-container">
                    <form method="post" action="{% url 'upload_analyze' %}" enctype="multipart/form-data" id="uploadForm">
                        {% csrf_token %}
                        <div class="upload-area" id="uploadArea">
                            <input type="file" name="image" id="imageInput" accept="image/jpeg,image/jpg,image/png,image/webp" required style="display: none;">
                            <div class="upload-placeholder">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üì∑</div>
                                <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn</p>
                                <p style="color: var(--text-muted); font-size: 0.9rem;">H·ªó tr·ª£: JPG, PNG, WebP (t·ªëi ƒëa 10MB)</p>
                            </div>
                            <img id="previewImage" style="display: none; max-width: 100%; max-height: 400px; border-radius: var(--border-radius-sm); margin-top: 1rem;">
                        </div>
                        <div style="text-align: center; margin-top: 1rem;">
                            <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn" disabled>
                                üîç Ph√¢n t√≠ch ·∫£nh
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Controls Sidebar -->
        <div class="controls-sidebar" id="controlsSidebar">
            <h3 style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                <span>‚öôÔ∏è ƒêi·ªÅu khi·ªÉn Camera</span>
                <button onclick="toggleSidebar()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; display: none;" id="closeSidebar">√ó</button>
            </h3>
            
            <!-- Preset Selector (Unified Dropdown) -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 0.75rem; font-size: 1rem;">Ch·∫ø ƒë·ªô nhanh (Preset)</h4>
                
                <!-- Unified Preset Dropdown -->
                <div style="margin-bottom: 1rem;">
                    <label style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem; display: block;">Ch·ªçn preset:</label>
                    <select id="unifiedPresetSelect" class="form-control" style="margin-bottom: 0.5rem; font-size: 0.9rem;" onchange="handlePresetChange()">
                        <optgroup label="üîß M·∫∑c ƒë·ªãnh" id="defaultPresetsGroup">
                            <option value="system:auto">üîÑ T·ª± ƒë·ªông (M·∫∑c ƒë·ªãnh)</option>
                        </optgroup>
                        <optgroup label="üåø Ch·ª•p l√° c√¢y" id="leafPresetsGroup">
                            <option value="system:leaf_sharp">üçÉ L√° c√¢y - S·∫Øc n√©t</option>
                            <option value="system:leaf_vivid">üåà L√° c√¢y - M√†u r·ª±c</option>
                            <option value="system:leaf_macro">üîç L√° c√¢y - C·∫≠n c·∫£nh</option>
                            <option value="system:leaf_shadow">üåë L√° c√¢y - B√≥ng r√¢m</option>
                        </optgroup>
                        <optgroup label="‚òÄÔ∏è C∆° b·∫£n" id="basicPresetsGroup">
                            <option value="system:daylight">‚òÄÔ∏è Ban ng√†y</option>
                            <option value="system:cloudy">‚òÅÔ∏è Tr·ªùi nhi·ªÅu m√¢y</option>
                            <option value="system:indoor">üè† Trong nh√†</option>
                            <option value="system:night">üåô Ban ƒë√™m</option>
                        </optgroup>
                        <optgroup label="üì∑ Chuy√™n d·ª•ng" id="specialPresetsGroup">
                            <option value="system:sport">‚ö° Th·ªÉ thao</option>
                            <option value="system:portrait">üë§ Ch√¢n dung</option>
                            <option value="system:document">üìÑ T√†i li·ªáu</option>
                            <option value="system:security">üîí An ninh</option>
                        </optgroup>
                        <optgroup label="üë§ C·ªßa t√¥i" id="userPresetsGroup">
                            <!-- User presets will be loaded here -->
                        </optgroup>
                    </select>
                    <div style="display: flex; gap: 0.25rem;">
                        <button class="btn btn-sm btn-success" onclick="applySelectedPreset()" style="flex: 1; font-size: 0.85rem;">‚úÖ √Åp d·ª•ng</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSelectedPreset()" style="font-size: 0.85rem;" id="deletePresetBtn" disabled>üóëÔ∏è X√≥a</button>
                    </div>
                </div>
                
                <p id="presetStatus" style="color: var(--text-muted); font-size: 0.85rem; margin: 0;"></p>
            </div>
            
            <!-- YOLO Leaf Detection Controls -->
            <div class="yolo-controls-section">
                <h4>ü§ñ Nh·∫≠n di·ªán l√° t·ª± ƒë·ªông (AI)</h4>
                
                <div class="yolo-confidence-control">
                    <label>ƒê·ªô tin c·∫≠y t·ªëi thi·ªÉu: <span id="confidenceValue">35%</span></label>
                    <input type="range" id="yoloConfidence" min="10" max="90" value="35" 
                           oninput="updateConfidenceDisplay(this.value)" class="form-control">
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" id="yoloToggleBtn" onclick="toggleYOLODetection()" style="flex: 1; font-size: 0.85rem;">
                        üîç B·∫Øt ƒë·∫ßu qu√©t l√°
                    </button>
                </div>
                
                <small style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-top: 0.5rem;">
                    üí° Nh·∫•n v√†o khung xanh tr√™n video ƒë·ªÉ c·∫Øt v√† ph√¢n t√≠ch l√°
                </small>
            </div>
            
            <!-- Save Current Settings -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 0.75rem; font-size: 1rem;">L∆∞u th√¥ng s·ªë hi·ªán t·∫°i</h4>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <input type="text" id="presetNameInput" class="form-control" placeholder="T√™n preset..." style="flex: 1; font-size: 0.9rem;">
                    <button class="btn btn-sm btn-primary" onclick="saveCurrentPreset()" style="font-size: 0.85rem;">üíæ L∆∞u</button>
                </div>
                <label style="font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="setAsDefault">
                    <span>ƒê·∫∑t l√†m m·∫∑c ƒë·ªãnh</span>
                </label>
            </div>
            
            <!-- Resolution Settings -->
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-primary); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 0.75rem; font-size: 1rem;">üìê ƒê·ªô ph√¢n gi·∫£i</h4>
                <div style="margin-bottom: 0.5rem;">
                    <label style="font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Ch·ªçn ƒë·ªô ph√¢n gi·∫£i:</label>
                    <select id="resolutionProfile" class="form-control" style="font-size: 0.9rem; margin-bottom: 0.5rem;">
                        <option value="">ƒêang t·∫£i...</option>
                    </select>
                    <div id="resolutionInfo" style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-secondary); border-radius: var(--border-radius-sm);">
                        <div><strong>Hi·ªán t·∫°i:</strong> <span id="currentResolution">-</span></div>
                        <div><strong>Megapixels:</strong> <span id="currentMegapixels">-</span> MP</div>
                        <div><strong>Max FPS:</strong> <span id="currentMaxFps">-</span> fps</div>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="changeResolution()" style="width: 100%; font-size: 0.85rem;">üîÑ √Åp d·ª•ng ƒë·ªô ph√¢n gi·∫£i</button>
                    <small style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-top: 0.25rem;">
                        ‚ö†Ô∏è Thay ƒë·ªïi ƒë·ªô ph√¢n gi·∫£i s·∫Ω kh·ªüi ƒë·ªông l·∫°i camera
                    </small>
                </div>
            </div>
            
            <!-- Manual Settings - User-Friendly UI -->
            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem; font-size: 1rem;">ƒêi·ªÅu ch·ªânh h√¨nh ·∫£nh</h4>
                
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Zoom: 1x ƒë·∫øn 4x (gi·ªëng c√°c ·ª©ng d·ª•ng camera) -->
                    <div>
                        <label style="font-size: 0.9rem; display: block; margin-bottom: 0.25rem;">üîç ƒê·ªô ph√≥ng ƒë·∫°i: <span id="zoomValue">1.0x</span> <span id="zoomQuality" class="badge" style="margin-left: 0.5rem; font-size: 0.75rem;"></span></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('zoom', -0.1)" style="font-size: 0.85rem; min-width: 2rem;">-</button>
                            <input type="range" id="zoom" class="form-control" min="1" max="4" step="0.1" value="1" 
                                   oninput="updateUISettingDisplay('zoom', this.value); debouncedApplyUISetting('zoom', 'zoom');">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('zoom', 0.1)" style="font-size: 0.85rem; min-width: 2rem;">+</button>
                        </div>
                        <small id="zoomHint" style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-top: 0.25rem;">
                            1.0x = kh√¥ng zoom, 2.0x = zoom 2x, 4.0x = zoom 4x
                        </small>
                    </div>
                    
                    <!-- Brightness: -100% ƒë·∫øn +100% v·ªõi 0% = m·∫∑c ƒë·ªãnh -->
                    <div>
                        <label style="font-size: 0.9rem; display: block; margin-bottom: 0.25rem;">‚òÄÔ∏è ƒê·ªô s√°ng: <span id="brightnessValue">0%</span></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('brightness', -5)" style="font-size: 0.85rem; min-width: 2rem;">-</button>
                        <input type="range" id="brightness" class="form-control" min="-100" max="100" step="5" value="0" 
                                   oninput="updateUISettingDisplay('brightness', this.value); debouncedApplyUISetting('brightness', 'brightness');">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('brightness', 5)" style="font-size: 0.85rem; min-width: 2rem;">+</button>
                        </div>
                        <small style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-top: 0.25rem;">0% = m·∫∑c ƒë·ªãnh, -100% = r·∫•t t·ªëi, +100% = r·∫•t s√°ng</small>
                    </div>
                    
                    <!-- Sharpness: -100% ƒë·∫øn +100% v·ªõi 0% = m·∫∑c ƒë·ªãnh -->
                    <div>
                        <label style="font-size: 0.9rem; display: block; margin-bottom: 0.25rem;">üîé ƒê·ªô n√©t: <span id="sharpnessValue">0%</span></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('sharpness', -5)" style="font-size: 0.85rem; min-width: 2rem;">-</button>
                            <input type="range" id="sharpness" class="form-control" min="-100" max="100" step="5" value="0" 
                                   oninput="updateUISettingDisplay('sharpness', this.value); debouncedApplyUISetting('sharpness', 'sharpness');">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('sharpness', 5)" style="font-size: 0.85rem; min-width: 2rem;">+</button>
                        </div>
                        <small style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-top: 0.25rem;">0% = m·∫∑c ƒë·ªãnh. Hi·ªáu ·ª©ng r√µ nh·∫•t khi ch·ª•p ·∫£nh.</small>
                    </div>
                    
                    <!-- Contrast: -100% ƒë·∫øn +100% v·ªõi 0% = m·∫∑c ƒë·ªãnh -->
                    <div>
                        <label style="font-size: 0.9rem; display: block; margin-bottom: 0.25rem;">üé® ƒê·ªô t∆∞∆°ng ph·∫£n: <span id="contrastValue">0%</span></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('contrast', -5)" style="font-size: 0.85rem; min-width: 2rem;">-</button>
                            <input type="range" id="contrast" class="form-control" min="-100" max="100" step="5" value="0" 
                                   oninput="updateUISettingDisplay('contrast', this.value); debouncedApplyUISetting('contrast', 'contrast');">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('contrast', 5)" style="font-size: 0.85rem; min-width: 2rem;">+</button>
                        </div>
                        <small style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-top: 0.25rem;">0% = m·∫∑c ƒë·ªãnh, -100% = ph·∫≥ng, +100% = cao</small>
                    </div>
                    
                    <!-- Saturation: -100% ƒë·∫øn +100% v·ªõi 0% = m·∫∑c ƒë·ªãnh -->
                    <div>
                        <label style="font-size: 0.9rem; display: block; margin-bottom: 0.25rem;">üåà ƒê·ªô b√£o h√≤a m√†u: <span id="saturationValue">0%</span></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('saturation', -5)" style="font-size: 0.85rem; min-width: 2rem;">-</button>
                            <input type="range" id="saturation" class="form-control" min="-100" max="100" step="5" value="0" 
                                   oninput="updateUISettingDisplay('saturation', this.value); debouncedApplyUISetting('saturation', 'saturation');">
                            <button class="btn btn-sm btn-secondary" onclick="adjustUISetting('saturation', 5)" style="font-size: 0.85rem; min-width: 2rem;">+</button>
                        </div>
                        <small style="font-size: 0.75rem; color: var(--text-muted); display: block; margin-top: 0.25rem;">0% = m·∫∑c ƒë·ªãnh, -100% = ƒëen tr·∫Øng, +100% = m√†u ƒë·∫≠m</small>
                    </div>
                </div>
                
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button class="btn btn-sm btn-secondary" onclick="loadUISettings()" style="flex: 1; font-size: 0.85rem;">üì• T·∫£i th√¥ng s·ªë</button>
                    <button class="btn btn-sm btn-secondary" onclick="resetToDefault()" style="flex: 1; font-size: 0.85rem;">üîÑ M·∫∑c ƒë·ªãnh</button>
                </div>
            </div>
            
            <!-- System Control -->
            <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-primary); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 0.75rem; font-size: 1rem;">ƒêi·ªÅu khi·ªÉn h·ªá th·ªëng</h4>
                <div style="display: flex; gap: 0.5rem; flex-direction: column;">
                    <button class="btn btn-sm btn-warning" onclick="restartCamera()" style="font-size: 0.85rem;">üîÑ Kh·ªüi ƒë·ªông l·∫°i Camera</button>
                    <button class="btn btn-sm btn-warning" onclick="reloadModel()" style="font-size: 0.85rem;">üîÑ T·∫£i l·∫°i Model</button>
                </div>
            </div>
            
            <!-- Current Settings Info (Expanded) -->
            <div style="padding: 1rem; background: var(--bg-primary); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); max-height: 70vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <h4 style="margin: 0; font-size: 1rem;">Tr·∫°ng th√°i Camera</h4>
                    <button class="btn btn-sm btn-secondary" onclick="refreshCameraStatus()" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">üîÑ</button>
                </div>
                
                <!-- System Status -->
                <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--primary);">H·ªá th·ªëng</h5>
                <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>Tr·∫°ng th√°i:</strong> <span id="settingsState">-</span></p>
                <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>Preset:</strong> <span id="settingsPreset">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>Ch·∫ø ƒë·ªô:</strong> <span id="settingsMode">-</span></p>
            </div>
                
                <!-- Resolution Info -->
                <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--primary);">ƒê·ªô ph√¢n gi·∫£i</h5>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>K√≠ch th∆∞·ªõc:</strong> <span id="statusResolution">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>Megapixels:</strong> <span id="statusMegapixels">-</span> MP</p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>Frame Rate:</strong> <span id="statusFps">-</span> <span>fps</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>T·ª∑ l·ªá khung h√¨nh:</strong> <span id="statusAspectRatio">-</span></p>
        </div>
                
                <!-- Exposure Settings -->
                <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--primary);">Ph∆°i s√°ng</h5>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>ISO (AnalogueGain):</strong> <span id="statusAnalogueGain">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>Th·ªùi gian ph∆°i s√°ng:</strong> <span id="statusExposureTime">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>B√π ph∆°i s√°ng (EV):</strong> <span id="statusExposureValue">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>T·ª± ƒë·ªông ph∆°i s√°ng:</strong> <span id="statusAeEnable">-</span></p>
                </div>
                
                <!-- Image Quality Settings -->
                <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                    <h5 style="font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--primary);">Ch·∫•t l∆∞·ª£ng h√¨nh ·∫£nh</h5>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>ƒê·ªô t∆∞∆°ng ph·∫£n:</strong> <span id="statusContrast">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>ƒê·ªô b√£o h√≤a:</strong> <span id="statusSaturation">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>ƒê·ªô n√©t:</strong> <span id="statusSharpness">-</span></p>
                    <p style="font-size: 0.85rem; margin: 0.25rem 0;"><strong>C√¢n b·∫±ng tr·∫Øng t·ª± ƒë·ªông:</strong> <span id="statusAwbEnable">-</span></p>
                </div>
            </div>
        </div>
    </div>
</div>
  
  <script src="{% static 'js/camera-status-board.js' %}"></script>
  <script src="{% static 'js/search.js' %}"></script>
  <script src="{% static 'js/camera-controls.js' %}"></script>
  <script src="{% static 'js/search-page.js' %}"></script>
  <script src="{% static 'js/yolo-detection.js' %}"></script>
  <script>
    // Kh·ªüi t·∫°o
    const PI_BASE_URL = '{{ pi_base }}';
    const STREAM_URL = '{{ stream_url }}';
    
    // Ki·ªÉm tra tr·∫°ng th√°i khi load
    checkPiStatus();
    setInterval(checkPiStatus, 30000);
    loadUnifiedPresets(); // Load unified presets khi trang load
    
    // Load camera settings CH·ªà M·ªòT L·∫¶N khi trang load
    // Kh√¥ng auto-refresh - theo pattern c·ªßa c√°c ·ª©ng d·ª•ng camera chuy√™n nghi·ªáp
    setTimeout(async () => {
        if (window.CameraStatusBoard) {
            await window.CameraStatusBoard.loadFromCamera();
            refreshCameraStatus();
        } else {
            refreshCameraStatus();
        }
    }, 500);
    
    // CH·ªà polling cho system status (online/offline), KH√îNG polling camera settings
    // Camera settings s·ª≠ d·ª•ng Optimistic Update - UI l√† source of truth
    // Kh√¥ng c·∫ßn auto-refresh v√¨:
    // 1. Th∆∞·ªùng ch·ªâ c√≥ 1 user ƒëi·ªÅu khi·ªÉn camera
    // 2. User expect slider gi·ªØ nguy√™n gi√° tr·ªã h·ªç ƒë√£ set
    // 3. Gi·∫£m complexity v√† network traffic
    
    // Load resolution profiles khi trang load
    if (window.loadResolutionProfiles) {
        setTimeout(() => {
            loadResolutionProfiles();
        }, 500); // ƒê·ª£i camera-controls.js kh·ªüi t·∫°o xong
    }
    
    // Sidebar toggle cho mobile
    function toggleSidebar() {
        const sidebar = document.getElementById('controlsSidebar');
        sidebar.classList.toggle('open');
    }
    
    // Tab switching
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.style.display = 'none';
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        document.getElementById(tabName + '-tab').style.display = 'block';
        document.getElementById('tab-' + tabName).classList.add('active');
    }
    
    // Upload functionality
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const previewImage = document.getElementById('previewImage');
    const uploadBtn = document.getElementById('uploadBtn');
    
    uploadArea.addEventListener('click', () => imageInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--primary)';
        uploadArea.style.background = 'rgba(212, 175, 55, 0.05)';
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = 'var(--border-color)';
        uploadArea.style.background = 'var(--bg-primary)';
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--border-color)';
        uploadArea.style.background = 'var(--bg-primary)';
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type.startsWith('image/')) {
            imageInput.files = files;
            handleFileSelect(files[0]);
        }
    });
    
    imageInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    function handleFileSelect(file) {
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert('Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh: JPG, PNG, WebP');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            alert('File ·∫£nh qu√° l·ªõn (t·ªëi ƒëa 10MB)');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block';
            document.querySelector('.upload-placeholder').style.display = 'none';
            uploadBtn.disabled = false;
        };
        reader.readAsDataURL(file);
    }
    
    // Capture form - Two-step process: Preview first, then analyze
    document.getElementById('captureForm').addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default form submission
        
        const captureBtn = document.getElementById('captureBtn');
        const streamOverlay = document.getElementById('streamOverlay');
        const streamImage = document.getElementById('streamImage');
        const originalStreamUrl = streamImage.src;
        
        // Step 1: Disable button and show loading
        captureBtn.disabled = true;
        captureBtn.textContent = 'üì∏ ƒêang ch·ª•p...';
        streamOverlay.style.display = 'flex';
        
        // Step 2: Capture preview (ch·ªâ capture, KH√îNG ph√¢n t√≠ch)
        fetch('/api/capture/preview/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'L·ªói ch·ª•p ·∫£nh');
            }
            
            // Step 3: Hi·ªÉn th·ªã ·∫£nh ƒë√£ ch·ª•p ngay l·∫≠p t·ª©c (t·∫°o hi·ªáu ·ª©ng "d·ª´ng h√¨nh")
            let capturedImageUrl = '';
            if (data.image_b64_thumbnail) {
                capturedImageUrl = 'data:image/jpeg;base64,' + data.image_b64_thumbnail;
                streamImage.src = capturedImageUrl;
            } else if (data.image_b64) {
                capturedImageUrl = 'data:image/jpeg;base64,' + data.image_b64;
                streamImage.src = capturedImageUrl;
            } else if (data.image_url) {
                if (data.image_url.startsWith('/')) {
                    capturedImageUrl = PI_BASE_URL + data.image_url;
                } else {
                    capturedImageUrl = data.image_url;
                }
                streamImage.src = capturedImageUrl;
            } else if (data.file) {
                capturedImageUrl = PI_BASE_URL + '/history/image/' + data.file;
                streamImage.src = capturedImageUrl;
            }
            
            // Step 4: Hi·ªÉn th·ªã panel ngay v·ªõi loading state
            captureBtn.textContent = 'üîç ƒêang ph√¢n t√≠ch...';
            showAnalysisPanelLoading({
                file: data.file,
                image_url: capturedImageUrl || (data.image_url ? (data.image_url.startsWith('/') ? PI_BASE_URL + data.image_url : data.image_url) : ''),
                image_size_bytes: data.image_size_bytes,
                zoom_info: data.zoom_info || null,
                quality_info: data.quality_info || null
            });
            
            // Step 5: Ph√¢n t√≠ch ·∫£nh ƒë√£ capture ·ªü background
            fetch('/api/capture/analyze/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    filename: data.file
                }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(analysisResult => {
                if (!analysisResult.success) {
                    throw new Error(analysisResult.error || 'L·ªói ph√¢n t√≠ch');
                }
                
                // Step 6: C·∫≠p nh·∫≠t panel v·ªõi k·∫øt qu·∫£ ph√¢n t√≠ch
                captureBtn.textContent = '‚úÖ Ho√†n th√†nh!';
                updateAnalysisPanelWithResult(analysisResult);
                
                // Restore stream
                streamImage.src = originalStreamUrl;
                captureBtn.disabled = false;
                captureBtn.textContent = 'üì∏ Ch·ª•p ·∫£nh v√† ph√¢n t√≠ch';
                streamOverlay.style.display = 'none';
            })
            .catch(error => {
                console.error('Analysis error:', error);
                // Hi·ªÉn th·ªã l·ªói trong panel
                updateAnalysisPanelWithError(error.message);
                // Restore stream
                streamImage.src = originalStreamUrl;
                captureBtn.disabled = false;
                captureBtn.textContent = 'üì∏ Ch·ª•p ·∫£nh v√† ph√¢n t√≠ch';
                streamOverlay.style.display = 'none';
            });
        })
        .catch(error => {
            console.error('Capture error:', error);
            alert('L·ªói: ' + error.message);
            
            // Restore stream
            streamImage.src = originalStreamUrl;
            captureBtn.disabled = false;
            captureBtn.textContent = 'üì∏ Ch·ª•p ·∫£nh v√† ph√¢n t√≠ch';
            streamOverlay.style.display = 'none';
        });
    });
    
    // Analysis Panel Functions
    let currentAnalysisData = null; // L∆∞u d·ªØ li·ªáu ph√¢n t√≠ch hi·ªán t·∫°i
    
    function showAnalysisPanelLoading(previewData) {
        const panel = document.getElementById('analysisPanel');
        const panelBody = document.getElementById('analysisPanelBody');
        const panelFooter = document.querySelector('.analysis-panel-footer');
        
        // L∆∞u preview data
        currentAnalysisData = {
            ...previewData,
            loading: true
        };
        
        // T·∫°o HTML cho panel v·ªõi loading state
        panelBody.innerHTML = `
            <div class="analysis-image-section">
                <img src="${escapeHtml(previewData.image_url)}" alt="Captured image" id="analysisPanelImage">
            </div>
            
            <div class="analysis-info-grid">
                <div class="analysis-info-card">
                    <h3>üåø T√™n ti·∫øng Vi·ªát</h3>
                    <p class="value"><span class="loading-skeleton"></span></p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üî¨ T√™n khoa h·ªçc</h3>
                    <p class="value"><span class="loading-skeleton"></span></p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üåç T√™n ti·∫øng Anh</h3>
                    <p class="value"><span class="loading-skeleton"></span></p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üìä ƒê·ªô tin c·∫≠y</h3>
                    <div class="confidence-display">
                        <span class="confidence-value"><span class="loading-skeleton" style="width: 60px;"></span></span>
                        <div class="confidence-bar-container">
                            <div class="confidence-bar">
                                <div class="confidence-bar-fill" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üìè K√≠ch th∆∞·ªõc ·∫£nh</h3>
                    <p class="value">${previewData.image_size_bytes ? (previewData.image_size_bytes / 1024).toFixed(1) + ' KB' : 'N/A'}</p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üìÖ Th·ªùi gian</h3>
                    <p class="value">${new Date().toLocaleString('vi-VN')}</p>
                </div>
                
                <div class="analysis-info-card" id="zoomInfoCard" style="display: ${previewData.zoom_info ? 'block' : 'none'};">
                    <h3>üîç Ch·∫•t l∆∞·ª£ng ·∫£nh</h3>
                    <p class="value">${previewData.quality_info || 'Full resolution'}</p>
                    ${previewData.zoom_info ? `<small style="color: var(--text-muted);">Zoom ${previewData.zoom_info.zoom}x ‚Ä¢ ${previewData.zoom_info.cropped_size ? previewData.zoom_info.cropped_size[0] + 'x' + previewData.zoom_info.cropped_size[1] : 'N/A'}</small>` : ''}
                </div>
            </div>
            
            <div class="analysis-detail-section">
                <h3>üìù M√¥ t·∫£ chi ti·∫øt</h3>
                <div class="analysis-detail-content"><span class="loading-skeleton"></span></div>
            </div>
            
            <div class="analysis-detail-section">
                <h3>üíä C√¥ng d·ª•ng</h3>
                <div class="analysis-detail-content"><span class="loading-skeleton"></span></div>
            </div>
            
            <div class="analysis-detail-section">
                <h3>üìç V·ªã tr√≠ ph√¢n b·ªë</h3>
                <div class="analysis-detail-content"><span class="loading-skeleton"></span></div>
            </div>
        `;
        
        // C·∫≠p nh·∫≠t footer v·ªõi n√∫t disabled
        if (panelFooter) {
            panelFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeAnalysisPanel()">ƒê√≥ng</button>
                <button class="btn btn-primary btn-save" id="saveResultBtn" disabled>
                    üíæ L∆∞u k·∫øt qu·∫£
                </button>
            `;
        }
        
        // Hi·ªÉn th·ªã panel v·ªõi animation
        panel.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
    
    function updateAnalysisPanelWithResult(analysisResult) {
        const panelBody = document.getElementById('analysisPanelBody');
        const panelFooter = document.querySelector('.analysis-panel-footer');
        
        // Ki·ªÉm tra c√°c tr∆∞·ªùng h·ª£p kh√¥ng ƒë∆∞·ª£c l∆∞u
        const label = (analysisResult.name || '').toLowerCase();
        const isNotSavable = label === 'background' || label === 'green_but_not_leaf';
        
        // X√°c ƒë·ªãnh ƒë·ªô tin c·∫≠y v√† m√†u s·∫Øc
        const confidencePercent = Math.round((analysisResult.confidence || 0) * 100);
        let confidenceClass = 'high';
        let confidenceColor = '#4CAF50';
        if (confidencePercent < 70) {
            confidenceClass = 'medium';
            confidenceColor = '#FF9800';
        }
        if (confidencePercent < 50) {
            confidenceClass = 'low';
            confidenceColor = '#F44336';
        }
        
        // Gi·ªØ l·∫°i image_url t·ª´ preview n·∫øu ƒë√£ c√≥ (∆∞u ti√™n base64 ho·∫∑c full URL t·ª´ preview)
        // Ch·ªâ d√πng image_url t·ª´ analysisResult n·∫øu preview kh√¥ng c√≥
        let preservedImageUrl = '';
        if (currentAnalysisData?.image_url) {
            // ∆Øu ti√™n image_url t·ª´ preview (c√≥ th·ªÉ l√† base64 ho·∫∑c full URL)
            preservedImageUrl = currentAnalysisData.image_url;
            console.log('[Panel] Using image_url from preview:', preservedImageUrl.substring(0, 50) + '...');
        } else if (analysisResult.image_url) {
            // Fallback: d√πng image_url t·ª´ analysisResult
            preservedImageUrl = analysisResult.image_url.startsWith('/') ? 
                                PI_BASE_URL + analysisResult.image_url : 
                                analysisResult.image_url;
            console.log('[Panel] Using image_url from analysisResult:', preservedImageUrl);
        } else if (analysisResult.file) {
            // Fallback cu·ªëi c√πng: t·∫°o URL t·ª´ filename
            preservedImageUrl = PI_BASE_URL + '/history/image/' + analysisResult.file;
            console.log('[Panel] Using image_url from filename:', preservedImageUrl);
        }
        
        if (!preservedImageUrl) {
            console.warn('[Panel] No image_url found!', { currentAnalysisData, analysisResult });
        }
        
        // C·∫≠p nh·∫≠t currentAnalysisData - gi·ªØ l·∫°i image_url t·ª´ preview
        // Lo·∫°i b·ªè image_url t·ª´ analysisResult tr∆∞·ªõc khi merge ƒë·ªÉ tr√°nh ghi ƒë√®
        const { image_url: _, ...analysisResultWithoutImageUrl } = analysisResult;
        currentAnalysisData = {
            ...currentAnalysisData,
            ...analysisResultWithoutImageUrl,
            image_url: preservedImageUrl, // Lu√¥n d√πng preservedImageUrl (t·ª´ preview ho·∫∑c fallback)
            loading: false,
            isNotSavable: isNotSavable
        };
        
        // T·∫°o HTML v·ªõi k·∫øt qu·∫£ ph√¢n t√≠ch
        panelBody.innerHTML = `
            ${isNotSavable ? `
            <div class="analysis-warning-badge">
                ‚ö†Ô∏è K·∫øt qu·∫£ n√†y kh√¥ng ƒë∆∞·ª£c l∆∞u v√†o database: "${escapeHtml(analysisResult.name)}"
            </div>
            ` : ''}
            
            <div class="analysis-image-section">
                <img src="${escapeHtml(preservedImageUrl)}" alt="Captured image" id="analysisPanelImage" 
                     onerror="console.error('Failed to load image:', this.src); this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'400\\' height=\\'300\\'%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dominant-baseline=\\'middle\\' fill=\\'%23999\\'%3EKh√¥ng th·ªÉ t·∫£i ·∫£nh%3C/text%3E%3C/svg%3E';">
            </div>
            
            <div class="analysis-info-grid">
                <div class="analysis-info-card">
                    <h3>üåø T√™n ti·∫øng Vi·ªát</h3>
                    <p class="value">${escapeHtml(analysisResult.name || 'ƒêang ph√¢n t√≠ch...')}</p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üî¨ T√™n khoa h·ªçc</h3>
                    <p class="value empty">Ch∆∞a c√≥ th√¥ng tin</p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üåç T√™n ti·∫øng Anh</h3>
                    <p class="value empty">Ch∆∞a c√≥ th√¥ng tin</p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üìä ƒê·ªô tin c·∫≠y</h3>
                    <div class="confidence-display">
                        <span class="confidence-value" style="color: ${confidenceColor};">${confidencePercent}%</span>
                        <div class="confidence-bar-container">
                            <div class="confidence-bar">
                                <div class="confidence-bar-fill ${confidenceClass}" style="width: ${confidencePercent}%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üìè K√≠ch th∆∞·ªõc ·∫£nh</h3>
                    <p class="value">${currentAnalysisData.image_size_bytes ? (currentAnalysisData.image_size_bytes / 1024).toFixed(1) + ' KB' : 'N/A'}</p>
                </div>
                
                <div class="analysis-info-card">
                    <h3>üìÖ Th·ªùi gian</h3>
                    <p class="value">${new Date().toLocaleString('vi-VN')}</p>
                </div>
            </div>
            
            <div class="analysis-detail-section">
                <h3>üìù M√¥ t·∫£ chi ti·∫øt</h3>
                <div class="analysis-detail-content empty">Ch∆∞a c√≥ th√¥ng tin</div>
            </div>
            
            <div class="analysis-detail-section">
                <h3>üíä C√¥ng d·ª•ng</h3>
                <div class="analysis-detail-content empty">Ch∆∞a c√≥ th√¥ng tin</div>
            </div>
            
            <div class="analysis-detail-section">
                <h3>üìç V·ªã tr√≠ ph√¢n b·ªë</h3>
                <div class="analysis-detail-content empty">Ch∆∞a c√≥ th√¥ng tin</div>
            </div>
        `;
        
        // C·∫≠p nh·∫≠t footer v·ªõi n√∫t l∆∞u (disabled n·∫øu kh√¥ng ƒë∆∞·ª£c l∆∞u)
        if (panelFooter) {
            panelFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeAnalysisPanel()">ƒê√≥ng</button>
                <button class="btn btn-primary btn-save" id="saveResultBtn" onclick="saveAnalysisResult()" ${isNotSavable ? 'disabled' : ''}>
                    üíæ L∆∞u k·∫øt qu·∫£
                </button>
            `;
        }
    }
    
    function updateAnalysisPanelWithError(errorMessage) {
        const panelBody = document.getElementById('analysisPanelBody');
        const panelFooter = document.querySelector('.analysis-panel-footer');
        
        panelBody.innerHTML = `
            <div class="analysis-warning-badge">
                ‚ùå L·ªói ph√¢n t√≠ch: ${escapeHtml(errorMessage)}
            </div>
            
            <div class="analysis-image-section">
                <img src="${escapeHtml(currentAnalysisData?.image_url || '')}" alt="Captured image" id="analysisPanelImage">
            </div>
        `;
        
        if (panelFooter) {
            panelFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeAnalysisPanel()">ƒê√≥ng</button>
            `;
        }
    }
    
    function saveAnalysisResult() {
        if (!currentAnalysisData || currentAnalysisData.loading || currentAnalysisData.isNotSavable) {
            return;
        }
        
        const saveBtn = document.getElementById('saveResultBtn');
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.textContent = '‚è≥ ƒêang l∆∞u...';
        
        fetch('/api/capture/save/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: currentAnalysisData.name,
                confidence: currentAnalysisData.confidence,
                file: currentAnalysisData.file,
                image_url: currentAnalysisData.image_url,
                image_size_bytes: currentAnalysisData.image_size_bytes
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                const panelBody = document.getElementById('analysisPanelBody');
                const successBadge = document.createElement('div');
                successBadge.className = 'analysis-success-badge';
                successBadge.style.marginBottom = '1rem';
                successBadge.innerHTML = '‚úÖ ' + data.message;
                
                // Th√™m badge v√†o ƒë·∫ßu panel body
                panelBody.insertBefore(successBadge, panelBody.firstChild);
                
                // ƒê·ªïi n√∫t l∆∞u th√†nh "ƒê√£ l∆∞u"
                saveBtn.textContent = '‚úÖ ƒê√£ l∆∞u';
                saveBtn.disabled = true;
                saveBtn.classList.remove('btn-primary');
                saveBtn.classList.add('btn-secondary');
                
                // C·∫≠p nh·∫≠t currentAnalysisData ƒë·ªÉ ƒë√°nh d·∫•u ƒë√£ l∆∞u
                currentAnalysisData.saved = true;
                
                // C·∫≠p nh·∫≠t panel v·ªõi th√¥ng tin ƒë·∫ßy ƒë·ªß t·ª´ database n·∫øu c√≥
                if (data.result) {
                    updatePanelWithFullData(data.result);
                }
            } else {
                throw new Error(data.error || 'L·ªói l∆∞u k·∫øt qu·∫£');
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            alert('L·ªói: ' + error.message);
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        });
    }
    
    function updatePanelWithFullData(fullData) {
        const panelBody = document.getElementById('analysisPanelBody');
        
        // C·∫≠p nh·∫≠t c√°c tr∆∞·ªùng v·ªõi d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß t·ª´ database
        const nameCard = panelBody.querySelector('.analysis-info-card:nth-child(2) .value');
        if (nameCard) {
            nameCard.textContent = fullData.vietnamese_name || fullData.name || '';
            nameCard.classList.remove('empty');
        }
        
        const scientificCard = panelBody.querySelector('.analysis-info-card:nth-child(3) .value');
        if (scientificCard && fullData.scientific_name) {
            scientificCard.textContent = fullData.scientific_name;
            scientificCard.classList.remove('empty');
        }
        
        const englishCard = panelBody.querySelector('.analysis-info-card:nth-child(4) .value');
        if (englishCard && fullData.english_name) {
            englishCard.textContent = fullData.english_name;
            englishCard.classList.remove('empty');
        }
        
        // C·∫≠p nh·∫≠t c√°c section chi ti·∫øt
        if (fullData.description) {
            const descSection = panelBody.querySelector('.analysis-detail-section:nth-child(4) .analysis-detail-content');
            if (descSection) {
                descSection.textContent = fullData.description;
                descSection.classList.remove('empty');
            }
        }
        
        if (fullData.usage) {
            const usageSection = panelBody.querySelector('.analysis-detail-section:nth-child(5) .analysis-detail-content');
            if (usageSection) {
                usageSection.textContent = fullData.usage;
                usageSection.classList.remove('empty');
            }
        }
        
        if (fullData.common_locations) {
            const locationSection = panelBody.querySelector('.analysis-detail-section:nth-child(6) .analysis-detail-content');
            if (locationSection) {
                locationSection.textContent = fullData.common_locations;
                locationSection.classList.remove('empty');
            }
        }
        
        // Th√™m c√°c section kh√°c n·∫øu c√≥
        if (fullData.biological_info) {
            let bioSection = panelBody.querySelector('.analysis-detail-section:nth-child(7)');
            if (!bioSection) {
                bioSection = document.createElement('div');
                bioSection.className = 'analysis-detail-section';
                bioSection.innerHTML = `
                    <h3>üî¨ Th√¥ng tin sinh h·ªçc</h3>
                    <div class="analysis-detail-content">${escapeHtml(fullData.biological_info)}</div>
                `;
                panelBody.appendChild(bioSection);
            }
        }
        
        if (fullData.medicinal_info) {
            let medSection = panelBody.querySelector('.analysis-detail-section:nth-child(8)');
            if (!medSection) {
                medSection = document.createElement('div');
                medSection.className = 'analysis-detail-section';
                medSection.innerHTML = `
                    <h3>üíâ Th√¥ng tin d∆∞·ª£c li·ªáu</h3>
                    <div class="analysis-detail-content">${escapeHtml(fullData.medicinal_info)}</div>
                `;
                panelBody.appendChild(medSection);
            }
        }
    }
    
    function closeAnalysisPanel() {
        const panel = document.getElementById('analysisPanel');
        panel.classList.remove('show');
        document.body.style.overflow = ''; // Restore scrolling
        currentAnalysisData = null; // Reset data
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // ============================================================
    // CAMERA CONTROLS HELPERS - Simplified Logic
    // ============================================================
    
    // Debounce timers cho auto-apply
    const debounceTimers = {};
    
    // Map elementId to setting name
    const settingNameMap = {
        'zoom': 'zoom',
        'brightness': 'brightness',
        'sharpness': 'sharpness',
        'contrast': 'contrast',
        'saturation': 'saturation'
    };
    
    /**
     * Update UI display value (ch·ªâ update hi·ªÉn th·ªã, kh√¥ng apply)
     * QUAN TR·ªåNG: H√†m n√†y ch·ªâ update display text, KH√îNG update slider value
     * Slider value ƒë∆∞·ª£c update b·ªüi camera-controls.js th√¥ng qua updateControl()
     */
    function updateUISettingDisplay(elementId, value) {
        const val = parseFloat(value) || 0;
        const valueElement = document.getElementById(elementId + 'Value');
        if (!valueElement) return;
        
        // Format display ph√π h·ª£p v·ªõi t·ª´ng lo·∫°i setting
        if (elementId === 'zoom') {
            // Zoom: hi·ªÉn th·ªã d·∫°ng "1.0x", "2.0x", "4.0x" (gi·ªëng c√°c app camera)
            valueElement.textContent = val.toFixed(1) + 'x';
            // C·∫≠p nh·∫≠t ch·ªâ b√°o ch·∫•t l∆∞·ª£ng zoom
            updateZoomQuality(val);
        } else {
            // C√°c setting kh√°c: hi·ªÉn th·ªã d·∫•u +/- cho gi√° tr·ªã d∆∞∆°ng/√¢m
            const sign = val > 0 ? '+' : '';
            valueElement.textContent = sign + Math.round(val) + '%';
        }
        
        // Update slider background (ch·ªâ visual, kh√¥ng trigger event)
        const slider = document.getElementById(elementId);
        if (slider && window.cameraControls && window.cameraControls.ui) {
            window.cameraControls.ui.updateRangeBackground(slider);
        }
    }
    
    /**
     * C·∫≠p nh·∫≠t ch·ªâ b√°o ch·∫•t l∆∞·ª£ng zoom
     * Digital zoom l√†m gi·∫£m ch·∫•t l∆∞·ª£ng ·∫£nh khi zoom cao
     */
    function updateZoomQuality(zoomValue) {
        const qualityBadge = document.getElementById('zoomQuality');
        const zoomHint = document.getElementById('zoomHint');
        if (!qualityBadge) return;
        
        const zoom = parseFloat(zoomValue) || 1.0;
        
        if (zoom <= 1.5) {
            // 1x - 1.5x: Ch·∫•t l∆∞·ª£ng t·ªët nh·∫•t
            qualityBadge.textContent = 'T·ªët nh·∫•t';
            qualityBadge.style.background = 'var(--accent-success, #28a745)';
            if (zoomHint) zoomHint.textContent = 'Ch·∫•t l∆∞·ª£ng t·ªët nh·∫•t cho ch·ª•p v√† ph√¢n t√≠ch l√° c√¢y.';
        } else if (zoom <= 2.0) {
            // 1.5x - 2x: Ch·∫•t l∆∞·ª£ng t·ªët
            qualityBadge.textContent = 'T·ªët';
            qualityBadge.style.background = 'var(--accent-info, #17a2b8)';
            if (zoomHint) zoomHint.textContent = 'Ch·∫•t l∆∞·ª£ng t·ªët, ph√π h·ª£p cho preview v√† nh·∫≠n d·∫°ng.';
        } else if (zoom <= 3.0) {
            // 2x - 3x: Ch·∫•t l∆∞·ª£ng trung b√¨nh
            qualityBadge.textContent = 'Trung b√¨nh';
            qualityBadge.style.background = 'var(--accent-warning, #ffc107)';
            qualityBadge.style.color = '#000';
            if (zoomHint) zoomHint.textContent = '‚ö†Ô∏è Ch·∫•t l∆∞·ª£ng gi·∫£m. N√™n ƒë·∫∑t l√° g·∫ßn camera h∆°n thay v√¨ zoom.';
        } else {
            // 3x - 4x: Ch·∫•t l∆∞·ª£ng th·∫•p
            qualityBadge.textContent = 'Th·∫•p';
            qualityBadge.style.background = 'var(--accent-danger, #dc3545)';
            qualityBadge.style.color = '#fff';
            if (zoomHint) zoomHint.textContent = '‚ö†Ô∏è Ch·∫•t l∆∞·ª£ng th·∫•p! Kh√¥ng khuy·∫øn ngh·ªã ch·ª•p ·∫£nh ·ªü m·ª©c zoom n√†y.';
        }
    }
    
    /**
     * Apply UI setting v·ªõi validation
     */
    async function applyUISettingSafe(settingName, elementId) {
        const element = document.getElementById(elementId);
        if (!element) {
            console.error(`[UI] Element not found: ${elementId}`);
            return;
        }
        
        let value = parseFloat(element.value);
        
        // Validate
        if (isNaN(value)) {
            console.error(`[UI] Invalid value for ${settingName}:`, element.value);
            return;
        }
        
        // Clamp gi√° tr·ªã
        const min = parseFloat(element.min) || 0;
        const max = parseFloat(element.max) || 100;
        value = Math.max(min, Math.min(max, value));
        
        // Update element n·∫øu b·ªã clamp
        if (element.value != value) {
            element.value = value;
            updateUISettingDisplay(elementId, value);
        }
        
        // Apply setting
        if (window.cameraControls && window.cameraControls.applyUISetting) {
            try {
                await window.cameraControls.applyUISetting(settingName, value);
            } catch (error) {
                console.error(`[UI] Error applying ${settingName}:`, error);
                alert(`L·ªói khi √°p d·ª•ng ${settingName}: ${error.message}`);
            }
        } else {
            console.error('[UI] cameraControls not available');
        }
    }
    
    /**
     * Debounced apply - T·ª± ƒë·ªông apply sau khi user ng·ª´ng ƒëi·ªÅu ch·ªânh
     * 
     * OPTIMISTIC UPDATE PATTERN:
     * - UI c·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c (kh√¥ng ƒë·ª£i server)
     * - G·ª≠i request ƒë·∫øn server (background)
     * - N·∫øu error ‚Üí hi·ªÉn th·ªã th√¥ng b√°o, KH√îNG reset slider
     * - Slider gi·ªØ nguy√™n gi√° tr·ªã user ƒë√£ set
     */
    function debouncedApplyUISetting(settingName, elementId) {
        const element = document.getElementById(elementId);
        
        // Skip n·∫øu ƒëang update programmatically (ch·ªâ khi load l·∫ßn ƒë·∫ßu)
        if (element && element.dataset.programmaticUpdate === 'true') {
            console.log(`[UI] Skipping debounced apply for ${settingName} - programmatic update in progress`);
            return;
        }
        
        // Clear existing timer
        if (debounceTimers[settingName]) {
            clearTimeout(debounceTimers[settingName]);
        }
        
        // Set new timer (300ms delay - ƒë·ªß ƒë·ªÉ user ƒëi·ªÅu ch·ªânh tho·∫£i m√°i)
        debounceTimers[settingName] = setTimeout(() => {
            if (element && element.dataset.programmaticUpdate === 'true') {
                return;
            }
            applyUISettingSafe(settingName, elementId);
        }, 300);
    }
    
    /**
     * Adjust UI setting by step (d√πng cho n√∫t +/-)
     * OPTIMISTIC UPDATE: UI c·∫≠p nh·∫≠t ngay, g·ª≠i request background
     */
    /**
     * ƒêi·ªÅu ch·ªânh UI setting b·∫±ng n√∫t +/-
     * @param elementId - ID c·ªßa slider
     * @param delta - Gi√° tr·ªã thay ƒë·ªïi (v√≠ d·ª•: -5 cho brightness, -0.1 cho zoom)
     *                Gi√° tr·ªã n√†y l√† tr·ª±c ti·∫øp, KH√îNG nh√¢n v·ªõi step c·ªßa slider
     */
    function adjustUISetting(elementId, delta) {
        const element = document.getElementById(elementId);
        if (!element) {
            console.error(`[UI] Element not found: ${elementId}`);
            return;
        }
        
        const currentValue = parseFloat(element.value) || 0;
        const min = parseFloat(element.min) || 0;
        const max = parseFloat(element.max) || 100;
        
        // Calculate new value - delta l√† gi√° tr·ªã thay ƒë·ªïi tr·ª±c ti·∫øp
        let newValue = currentValue + delta;
        newValue = Math.max(min, Math.min(max, newValue));
        
        // Round ƒë·ªÉ tr√°nh floating point errors (v√≠ d·ª•: 1.0000000001)
        // Zoom: 1 decimal, others: integer
        if (elementId === 'zoom') {
            newValue = Math.round(newValue * 10) / 10;  // 1 decimal place
        } else {
            newValue = Math.round(newValue);  // Integer
        }
        
        // Update slider v√† display NGAY L·∫¨P T·ª®C (Optimistic Update)
        element.value = newValue;
        updateUISettingDisplay(elementId, newValue);
        
        // Update zoom quality badge n·∫øu l√† zoom
        if (elementId === 'zoom') {
            updateZoomQuality(newValue);
        }
        
        // Apply to camera (background, kh√¥ng block UI)
        const settingName = settingNameMap[elementId];
        if (settingName) {
            applyUISettingSafe(settingName, elementId);
        }
    }
    
    // ƒê√≥ng panel khi click v√†o overlay
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize YOLO detector
        window.yoloDetector = new YOLOLeafDetector('streamImage', 'yoloOverlayCanvas');
    });
    
    // Update confidence display
    function updateConfidenceDisplay(value) {
        document.getElementById('confidenceValue').textContent = value + '%';
        if (window.yoloDetector) {
            window.yoloDetector.setConfidence(value / 100);
        }
    }
  </script>

<!-- Analysis Result Panel -->
<div class="analysis-panel-overlay" id="analysisPanel">
    <div class="analysis-panel">
        <div class="analysis-panel-header">
            <h2>
                <span>üîç</span>
                <span>K·∫øt qu·∫£ ph√¢n t√≠ch</span>
            </h2>
            <button class="analysis-panel-close" onclick="closeAnalysisPanel()" aria-label="ƒê√≥ng">√ó</button>
        </div>
        <div class="analysis-panel-body" id="analysisPanelBody">
            <!-- Content will be populated by JavaScript -->
        </div>
        <div class="analysis-panel-footer">
            <button class="btn btn-secondary" onclick="closeAnalysisPanel()">ƒê√≥ng</button>
        </div>
    </div>
</div>

{% endblock %}
